- 把SSD的檔案覆蓋或刪除時，因nand erase最小單位是block的關係，直接erase會把還需要的檔案也刪掉
- 所以實際的做法會有一到兩個步驟
	- 1.把覆蓋或刪除檔案所佔用的nand page標記為無效
		- 標記的方法有分bitmap和P2L table兩種
	- 2.若是覆蓋，會在另一個page寫入新的data
- SSD經長久使用後，通常block內都會有很多page被標記為無效，無效的page就是所謂的垃圾
- 不能讓垃圾一直累積佔用空間，把垃圾清掉回收空間的動作，就是GC
- ### GC簡單示意圖
	- 把兩個block的有效資料集中在第三個block，再對原本兩個block做erase，這樣就可以回收這兩個block的空間繼續寫資料
	- ![image.png](../assets/image_1701420008304_0.png)
- ### GC的議題：OP和WA
	- OP = Over-Provision，超額配置
		- 一般來說SSD實際上的容量會比看到的更多，這些多出來的容量稱為OP
		- OP是為了GC而存在
		- OP比例 = (nand總容量-user可用容量)/user可用容量
		- OP會使SSD成本增加
	- WA = Write Amplification，寫入放大
		- 原本只要寫一次的data，因為各種原因會把這筆data搬來搬去，造成實際上會寫入好幾次，這個現象就叫"寫入放大"
			- 各種原因包括：GC、[[SLC cache]]的數據遷移
		- 寫入放大係數 = 實際寫入到nand的量/user寫入的量 #待處理
			- 例：在上面的"GC簡單示意圖"，block z原本有16格，在做完GC後已寫了7格，還剩下9格
				- 也就是說，block z的16格裡有7格是寫入第二次的舊資料，user只能再寫9格
				- 所以block z的寫入放大係數就是：(16+7)/9 = 1.4375
			- 空盤的寫入放大係數是1，也就是user寫入的資料量 = 寫到nand的資料量
			- 寫入放大係數越大，表示nand重覆寫data的量越大
				- 會影響性能，因為GC會佔用資料傳輸的頻寬
				- 也會造成block的壽命耗損越快
			- OP比例越大，有助於減小寫入放大，尤其是在空間吃緊的時候
				- 因為OP比例越大的話，block平均被分配到的op也越多，使得有效資料的比例降低
					- GC時搬移的就是有效資料，它的比例越小，GC搬移量和寫入放大也越小
					- op只能存放無效資料嗎？ #ftl問題
			- 通常越晚做GC，寫入放大也會越小
				- 因為隨著時間過越久，被更新的data也越多，也就會產生更多的垃圾->需要搬移的有效資料比例就越少
			- 用sequence write會的寫入放大會比用random write來得小
- ### GC的步驟
	- 一.挑選要回收的block
		- 方法1.選擇有效資料數量最小的block
			- 因為資料搬移量小，所以可以降低寫入放大係數
			- 需要多維護一張表Vaild Page Count(VPC)，用來計數每個block有效資料的量
		- 方法2.選擇erase次數最小的block(磨損均衡算法)
		- 也可以兩個方法同時考慮
	- 二.讀取欲回收block上的有效資料
		- 前提是，要如何知道每個block上每筆資料是有效 or 無效？
			- 方法1.為每個block建立一個有效/無效page的bitmap(稱作Vaild Page Bit Map - VPBM)
				- 但一個block內通常有上千個page，若是沒有DRAM可用，也必須進行多次換入換出的動作
				- 速度最快、耗費空間最大
			- 方法2.把data對應到的LBA寫進meta
				- 把整個block都讀出來，找出每一筆meta的LBA，並在L2P table中查詢該LBA對應到的物理位址是否和該筆data所在位址是否相同
					- 若是，則表示這是有效資料；反之則為無效
				- 速度最慢、佔用空間最小
			- 方法3.建立P2L table #ftl問題
				- 寫入時，會一併在P2L table標註物理位址對應到的LBA
				- GC時，會核對P2L表和L2P表來得知每個block的有效資料數量
				- 速度和佔用空間都介於中間
					- 為什麼P2L的佔用空間會比VPBM還低？P2L的最小單位不是page嗎？
	- 三.把有效資料寫到新的block
- ### GC的時機
	- 1.前景執行
		- 發現可用空間不足時被動觸發執行GC
	- 2.背景執行
		- SSD閒置時執行GC
		- 背景太頻繁GC會影響功耗